# Render deployment configuration for Brinkadata
# Docs: https://render.com/docs/blueprint-spec

services:
  # Backend API (FastAPI)
  - type: web
    name: brinkadata-backend
    runtime: python
    plan: standard  # Production tier for better performance
    region: oregon  # Choose your preferred region
    buildCommand: pip install -r requirements.txt
    startCommand: uvicorn backend.main:app --host 0.0.0.0 --port $PORT
    envVars:
      - key: ENV
        value: prod
      - key: DATABASE_URL
        fromDatabase:
          name: brinkadata-db
          property: connectionString
      - key: SECRET_KEY
        generateValue: true  # Render will auto-generate a secure secret
      - key: CORS_ORIGINS
        value: https://app.brinkadata.com,https://www.brinkadata.com
      - key: ALGORITHM
        value: HS256
      - key: ACCESS_TOKEN_MINUTES
        value: 15
      - key: REFRESH_TOKEN_DAYS
        value: 7
      - key: RESUME_CODE_MINUTES
        value: 10
    healthCheckPath: /health

  # Frontend (Streamlit)
  - type: web
    name: brinkadata-frontend
    runtime: python
    plan: standard  # Production tier for better performance
    region: oregon  # Choose your preferred region
    buildCommand: pip install -r requirements.txt
    startCommand: streamlit run frontend/app.py --server.port $PORT --server.address 0.0.0.0 --server.headless true
    envVars:
      - key: ENV
        value: prod
      - key: API_BASE_URL
        value: https://api.brinkadata.com
    healthCheckPath: /

databases:
  # Managed PostgreSQL database
  - name: brinkadata-db
    databaseName: brinkadata
    plan: standard-256  # Production tier with better performance
    region: oregon  # Must match service region for best performance
    postgresMajorVersion: 15

# Notes for deployment:
# 1) Push this render.yaml to your repo root
# 2) Connect repo to Render dashboard
# 3) Render will auto-detect this file and create resources
# 4) After first deploy, run migration:
#    - Go to Render Shell for backend service
#    - Run: python -m backend.migrate
# 5) For production domains:
#    - Backend: Add custom domain 'api.brinkadata.com' in Render dashboard
#    - Frontend: Add custom domain 'app.brinkadata.com' in Render dashboard
#    - Update GoDaddy DNS with CNAME records provided by Render
# 6) Production ENV vars are set to 'prod' with production domains
# 7) Database schema is already migrated from staging - DO NOT re-run migrations
